<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Breed Data Visualizations</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            font-family: Marker Felt, fantasy;
            font-weight: 200;
            background-color: #f5f5f5;
            overflow-x: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #4ECDC4 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        .dashboard {
            max-width: 1600px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 400px;
        }
        .chart-container h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .chart {
            width: 100%;
            height: 350px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2em;
        }
        .error {
            text-align: center;
            padding: 50px;
            color: #d32f2f;
            font-size: 1.2em;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        .back-link {
            display: inline-block;
            margin-top: 30px;
            padding: 10px 20px;
            background-color: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        .back-link:hover {
            background-color: #4ECDC4;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Dog Breed Data Visualizations</h1>
        <p>Insights into dog breed characteristics and distributions</p>
    </div>
    
    <div class="dashboard">
        <div id="loading" class="loading">Loading data...</div>
        <div id="error" class="error" style="display: none;"></div>
        
        <!-- Store data in a script tag for safe JSON parsing -->
        <script id="breed-data" type="application/json">{{ breed_data|tojson }}</script>
        
        <div id="charts-container" style="display: none;">
            <div class="charts-grid">
                <!-- Size Distribution -->
                <div class="chart-container">
                    <h3>Size Distribution</h3>
                    <div id="size-chart" class="chart"></div>
                </div>
                
                <!-- Breed Types -->
                <div class="chart-container">
                    <h3>Breed Types Distribution</h3>
                    <div id="type-chart" class="chart"></div>
                </div>
                
                <!-- Origin Distribution -->
                <div class="chart-container">
                    <h3>Top 15 Countries of Origin</h3>
                    <div id="origin-chart" class="chart"></div>
                </div>
                
                <!-- Grooming Needs -->
                <div class="chart-container">
                    <h3>Grooming Needs Distribution</h3>
                    <div id="grooming-chart" class="chart"></div>
                </div>
                
                <!-- Shedding Levels -->
                <div class="chart-container">
                    <h3>Shedding Levels Distribution</h3>
                    <div id="shedding-chart" class="chart"></div>
                </div>
                
                <!-- Good with Children -->
                <div class="chart-container">
                    <h3>Child-Friendly Breeds</h3>
                    <div id="children-chart" class="chart"></div>
                </div>
                
                <!-- Life Span Distribution -->
                <div class="chart-container">
                    <h3>Life Span Distribution</h3>
                    <div id="lifespan-chart" class="chart"></div>
                </div>
                
                <!-- Health Risk Distribution -->
                <div class="chart-container">
                    <h3>Health Issues Risk Distribution</h3>
                    <div id="health-chart" class="chart"></div>
                </div>
            </div>
        </div>
    </div>

    <a href="/" class="back-link">‚Üê Back to Home</a>

    <script>
        // Helper function to get column value (handles different column name formats)
        function getValue(d, columnName) {
            // Try exact match first
            if (d[columnName] !== undefined) return d[columnName];
            // Try with spaces
            const withSpaces = columnName.replace(/([A-Z])/g, ' $1').trim();
            if (d[withSpaces] !== undefined) return d[withSpaces];
            // Try common variations
            const variations = [
                columnName.replace(' ', ''),
                columnName.toLowerCase(),
                columnName.toUpperCase()
            ];
            for (const variant of variations) {
                if (d[variant] !== undefined) return d[variant];
            }
            return null;
        }

        // Get data from script tag
        const dataElement = document.getElementById('breed-data');
        const rawData = dataElement ? JSON.parse(dataElement.textContent) : [];
        
        // Process data
        if (!rawData || !Array.isArray(rawData) || rawData.length === 0) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = 'No data available. Please ensure the database is configured and contains dog breed data.';
        } else {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('charts-container').style.display = 'block';
            
            // Process data - normalize column names (handles database column names)
            const processedData = rawData.map(d => {
                    // Try to find the actual column names (database uses "Breed Name" and "Origin (Country)")
                    const keys = Object.keys(d);
                    const breedName = d['Breed Name'] || d['Name'] || d[keys.find(k => k.toLowerCase().includes('name'))] || '';
                    const origin = d['Origin (Country)'] || d['Origin'] || d[keys.find(k => k.toLowerCase().includes('origin'))] || '';
                    const type = d['Type'] || d[keys.find(k => k.toLowerCase().includes('type') && !k.toLowerCase().includes('breed'))] || '';
                    const size = d['Size'] || d[keys.find(k => k.toLowerCase().includes('size'))] || '';
                    const grooming = d['Grooming Needs'] || d[keys.find(k => k.toLowerCase().includes('grooming'))] || '';
                    const shedding = d['Shedding Level'] || d[keys.find(k => k.toLowerCase().includes('shedding'))] || '';
                    const children = d['Good with Children'] || d[keys.find(k => k.toLowerCase().includes('children'))] || '';
                    const health = d['Health Issues Risk'] || d[keys.find(k => k.toLowerCase().includes('health'))] || '';
                    const friendly = parseFloat(d['Friendly Rating (1-10)'] || d[keys.find(k => k.toLowerCase().includes('friendly'))] || 0);
                    const intelligence = parseFloat(d['Intelligence Rating (1-10)'] || d[keys.find(k => k.toLowerCase().includes('intelligence'))] || 0);
                    const lifespan = parseFloat(d['Life Span'] || d[keys.find(k => k.toLowerCase().includes('lifespan') || k.toLowerCase().includes('life span'))] || 0);
                    const weight = parseFloat(d['Average Weight (kg)'] || d[keys.find(k => k.toLowerCase().includes('weight'))] || 0);
                    
                    return {
                        name: breedName,
                        origin: origin,
                        type: type,
                        size: size,
                        grooming: grooming,
                        shedding: shedding,
                        children: children,
                        health: health,
                        friendly: friendly,
                        intelligence: intelligence,
                        lifespan: lifespan,
                        weight: weight
                    };
                }).filter(d => d.name); // Filter out entries without names
                
            // Create all visualizations
            createSizeChart(processedData);
            createTypeChart(processedData);
            createOriginChart(processedData);
            createGroomingChart(processedData);
            createSheddingChart(processedData);
            createChildrenChart(processedData);
            createLifespanChart(processedData);
            createHealthChart(processedData);
        }

        // Size Distribution Pie Chart
        function createSizeChart(data) {
            const sizeCounts = d3.rollup(data, v => v.length, d => d.size);
            const sizeData = Array.from(sizeCounts, ([key, value]) => ({size: key, count: value}))
                .filter(d => d.size).sort((a, b) => b.count - a.count);
            
            const width = 400;
            const height = 350;
            const radius = Math.min(width, height) / 2 - 40;
            
            const svg = d3.select('#size-chart')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const g = svg.append('g')
                .attr('transform', `translate(${width/2}, ${height/2})`);
            
            const color = d3.scaleOrdinal()
                .domain(sizeData.map(d => d.size))
                .range(['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8']);
            
            const pie = d3.pie()
                .value(d => d.count)
                .sort(null);
            
            const arc = d3.arc()
                .innerRadius(radius * 0.5)
                .outerRadius(radius);
            
            const arcs = g.selectAll('.arc')
                .data(pie(sizeData))
                .enter().append('g')
                .attr('class', 'arc');
            
            arcs.append('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.size))
                .attr('stroke', 'white')
                .attr('stroke-width', 2);
            
            arcs.append('text')
                .attr('transform', d => `translate(${arc.centroid(d)})`)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('font-weight', 'bold')
                .text(d => `${d.data.size}: ${d.data.count}`);
        }

        // Breed Types Bar Chart
        function createTypeChart(data) {
            const typeCounts = d3.rollup(data, v => v.length, d => d.type);
            const typeData = Array.from(typeCounts, ([key, value]) => ({type: key, count: value}))
                .filter(d => d.type).sort((a, b) => b.count - a.count);
            
            const margin = {top: 20, right: 20, bottom: 60, left: 60};
            const width = 400 - margin.left - margin.right;
            const height = 350 - margin.top - margin.bottom;
            
            const svg = d3.select('#type-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);
            
            const x = d3.scaleBand()
                .domain(typeData.map(d => d.type))
                .range([0, width])
                .padding(0.2);
            
            const y = d3.scaleLinear()
                .domain([0, d3.max(typeData, d => d.count)])
                .nice()
                .range([height, 0]);
            
            g.append('g')
                .attr('transform', `translate(0, ${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .style('text-anchor', 'end');
            
            g.append('g')
                .call(d3.axisLeft(y));
            
            g.selectAll('.bar')
                .data(typeData)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.type))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count))
                .attr('fill', '#667eea');
            
            g.selectAll('.label')
                .data(typeData)
                .enter().append('text')
                .attr('x', d => x(d.type) + x.bandwidth() / 2)
                .attr('y', d => y(d.count) - 5)
                .attr('text-anchor', 'middle')
                .style('font-size', '11px')
                .text(d => d.count);
        }

        // Origin Bar Chart (Top 15)
        function createOriginChart(data) {
            const originCounts = d3.rollup(data, v => v.length, d => d.origin);
            const originData = Array.from(originCounts, ([key, value]) => ({origin: key, count: value}))
                .filter(d => d.origin)
                .sort((a, b) => b.count - a.count)
                .slice(0, 15);
            
            const margin = {top: 20, right: 20, bottom: 60, left: 60};
            const width = 400 - margin.left - margin.right;
            const height = 350 - margin.top - margin.bottom;
            
            const svg = d3.select('#origin-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);
            
            const x = d3.scaleBand()
                .domain(originData.map(d => d.origin))
                .range([0, width])
                .padding(0.2);
            
            const y = d3.scaleLinear()
                .domain([0, d3.max(originData, d => d.count)])
                .nice()
                .range([height, 0]);
            
            g.append('g')
                .attr('transform', `translate(0, ${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .style('text-anchor', 'end');
            
            g.append('g')
                .call(d3.axisLeft(y));
            
            g.selectAll('.bar')
                .data(originData)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.origin))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count))
                .attr('fill', '#764ba2');
        }

        // Grooming Needs Bar Chart
        function createGroomingChart(data) {
            const groomingCounts = d3.rollup(data, v => v.length, d => d.grooming);
            const groomingData = Array.from(groomingCounts, ([key, value]) => ({grooming: key, count: value}))
                .filter(d => d.grooming)
                .sort((a, b) => {
                    const order = {'Low': 1, 'Moderate': 2, 'High': 3, 'Very High': 4};
                    return (order[a.grooming] || 99) - (order[b.grooming] || 99);
                });
            
            const margin = {top: 20, right: 20, bottom: 40, left: 60};
            const width = 400 - margin.left - margin.right;
            const height = 350 - margin.top - margin.bottom;
            
            const svg = d3.select('#grooming-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);
            
            const x = d3.scaleBand()
                .domain(groomingData.map(d => d.grooming))
                .range([0, width])
                .padding(0.2);
            
            const y = d3.scaleLinear()
                .domain([0, d3.max(groomingData, d => d.count)])
                .nice()
                .range([height, 0]);
            
            const color = d3.scaleOrdinal()
                .domain(groomingData.map(d => d.grooming))
                .range(['#4ECDC4', '#45B7D1', '#FFA07A', '#FF6B6B']);
            
            g.append('g')
                .attr('transform', `translate(0, ${height})`)
                .call(d3.axisBottom(x));
            
            g.append('g')
                .call(d3.axisLeft(y));
            
            g.selectAll('.bar')
                .data(groomingData)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.grooming))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count))
                .attr('fill', d => color(d.grooming));
        }

        // Shedding Levels Bar Chart
        function createSheddingChart(data) {
            const sheddingCounts = d3.rollup(data, v => v.length, d => d.shedding);
            const sheddingData = Array.from(sheddingCounts, ([key, value]) => ({shedding: key, count: value}))
                .filter(d => d.shedding)
                .sort((a, b) => {
                    const order = {'Low': 1, 'Moderate': 2, 'High': 3, 'Very High': 4};
                    return (order[a.shedding] || 99) - (order[b.shedding] || 99);
                });
            
            const margin = {top: 20, right: 20, bottom: 40, left: 60};
            const width = 400 - margin.left - margin.right;
            const height = 350 - margin.top - margin.bottom;
            
            const svg = d3.select('#shedding-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);
            
            const x = d3.scaleBand()
                .domain(sheddingData.map(d => d.shedding))
                .range([0, width])
                .padding(0.2);
            
            const y = d3.scaleLinear()
                .domain([0, d3.max(sheddingData, d => d.count)])
                .nice()
                .range([height, 0]);
            
            const color = d3.scaleOrdinal()
                .domain(sheddingData.map(d => d.shedding))
                .range(['#98D8C8', '#4ECDC4', '#FFA07A', '#FF6B6B']);
            
            g.append('g')
                .attr('transform', `translate(0, ${height})`)
                .call(d3.axisBottom(x));
            
            g.append('g')
                .call(d3.axisLeft(y));
            
            g.selectAll('.bar')
                .data(sheddingData)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.shedding))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count))
                .attr('fill', d => color(d.shedding));
        }

        // Good with Children Chart
        function createChildrenChart(data) {
            const childrenCounts = d3.rollup(data, v => v.length, d => d.children);
            const childrenData = Array.from(childrenCounts, ([key, value]) => ({children: key, count: value}))
                .filter(d => d.children);
            
            const margin = {top: 20, right: 20, bottom: 40, left: 60};
            const width = 400 - margin.left - margin.right;
            const height = 350 - margin.top - margin.bottom;
            
            const svg = d3.select('#children-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);
            
            const x = d3.scaleBand()
                .domain(childrenData.map(d => d.children))
                .range([0, width])
                .padding(0.2);
            
            const y = d3.scaleLinear()
                .domain([0, d3.max(childrenData, d => d.count)])
                .nice()
                .range([height, 0]);
            
            const color = d3.scaleOrdinal()
                .domain(childrenData.map(d => d.children))
                .range(['#4ECDC4', '#FFA07A', '#FF6B6B']);
            
            g.append('g')
                .attr('transform', `translate(0, ${height})`)
                .call(d3.axisBottom(x));
            
            g.append('g')
                .call(d3.axisLeft(y));
            
            g.selectAll('.bar')
                .data(childrenData)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.children))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count))
                .attr('fill', d => color(d.children));
        }

        // Life Span Histogram
        function createLifespanChart(data) {
            const lifespanData = data.filter(d => d.lifespan > 0).map(d => d.lifespan);
            
            const margin = {top: 20, right: 20, bottom: 40, left: 60};
            const width = 400 - margin.left - margin.right;
            const height = 350 - margin.top - margin.bottom;
            
            const svg = d3.select('#lifespan-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);
            
            const bins = d3.histogram()
                .domain(d3.extent(lifespanData))
                .thresholds(15)(lifespanData);
            
            const x = d3.scaleLinear()
                .domain(d3.extent(lifespanData))
                .range([0, width]);
            
            const y = d3.scaleLinear()
                .domain([0, d3.max(bins, d => d.length)])
                .nice()
                .range([height, 0]);
            
            g.append('g')
                .attr('transform', `translate(0, ${height})`)
                .call(d3.axisBottom(x).ticks(8))
                .append('text')
                .attr('x', width / 2)
                .attr('y', 35)
                .attr('fill', 'black')
                .style('text-anchor', 'middle')
                .text('Life Span (years)');
            
            g.append('g')
                .call(d3.axisLeft(y))
                .append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', -45)
                .attr('x', -height / 2)
                .attr('fill', 'black')
                .style('text-anchor', 'middle')
                .text('Number of Breeds');
            
            g.selectAll('.bar')
                .data(bins)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.x0))
                .attr('width', d => x(d.x1) - x(d.x0) - 1)
                .attr('y', d => y(d.length))
                .attr('height', d => height - y(d.length))
                .attr('fill', '#764ba2');
        }

        // Health Risk Distribution
        function createHealthChart(data) {
            const healthCounts = d3.rollup(data, v => v.length, d => d.health);
            const healthData = Array.from(healthCounts, ([key, value]) => ({health: key, count: value}))
                .filter(d => d.health)
                .sort((a, b) => {
                    const order = {'Low': 1, 'Moderate': 2, 'High': 3};
                    return (order[a.health] || 99) - (order[b.health] || 99);
                });
            
            const margin = {top: 20, right: 20, bottom: 40, left: 60};
            const width = 400 - margin.left - margin.right;
            const height = 350 - margin.top - margin.bottom;
            
            const svg = d3.select('#health-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);
            
            const x = d3.scaleBand()
                .domain(healthData.map(d => d.health))
                .range([0, width])
                .padding(0.2);
            
            const y = d3.scaleLinear()
                .domain([0, d3.max(healthData, d => d.count)])
                .nice()
                .range([height, 0]);
            
            const color = d3.scaleOrdinal()
                .domain(healthData.map(d => d.health))
                .range(['#98D8C8', '#FFA07A', '#FF6B6B']);
            
            g.append('g')
                .attr('transform', `translate(0, ${height})`)
                .call(d3.axisBottom(x));
            
            g.append('g')
                .call(d3.axisLeft(y));
            
            g.selectAll('.bar')
                .data(healthData)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.health))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.count))
                .attr('fill', d => color(d.health));
        }
    </script>
</body>
</html>
